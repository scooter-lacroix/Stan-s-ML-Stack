apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "performance-optimization-engine.fullname" . }}-manager
  labels:
    {{- include "performance-optimization-engine.labels" . | nindent 4 }}
    app.kubernetes.io/component: rbac
rules:
# Performance Engine permissions
- apiGroups: [""]
  resources: ["pods", "pods/log", "pods/status", "nodes", "nodes/proxy", "nodes/metrics", "services", "endpoints", "configmaps", "secrets"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets", "daemonsets", "statefulsets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["batch"]
  resources: ["jobs", "cronjobs"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["autoscaling"]
  resources: ["horizontalpodautoscalers", "verticalpodautoscalers"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["policy"]
  resources: ["poddisruptionbudgets", "podsecuritypolicies"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["networking.k8s.io"]
  resources: ["networkpolicies", "ingresses", "ingressclasses"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["metrics.k8s.io"]
  resources: ["pods", "nodes"]
  verbs: ["get", "list"]
- apiGroups: ["custom.metrics.k8s.io"]
  resources: ["*"]
  verbs: ["get", "list"]
- apiGroups: ["monitoring.coreos.com"]
  resources: ["prometheuses", "prometheusrules", "servicemonitors"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["integreatly.org"]
  resources: ["grafanadashboards"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["coordination.k8s.io"]
  resources: ["leases"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["scheduling.k8s.io"]
  resources: ["priorityclasses"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["storage.k8s.io"]
  resources: ["storageclasses", "volumeattachments", "csinodes"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["snapshot.storage.k8s.io"]
  resources: ["volumesnapshots", "volumesnapshotcontents", "volumesnapshotclasses"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["cert-manager.io"]
  resources: ["certificates", "issuers", "clusterissuers"]
  verbs: ["get", "list", "watch"]

# AMD GPU specific permissions
- apiGroups: [""]
  resources: ["pods/exec"]
  verbs: ["create"]
- apiGroups: [""]
  resources: ["pods/portforward"]
  verbs: ["create"]
- apiGroups: ["deviceplugin.k8s.io"]
  resources: ["deviceplugins"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["amd.com", "rocm.com"]
  resources: ["gpus", "gpudevices", "gpuclusters"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# NVIDIA GPU permissions (if enabled)
- apiGroups: ["nvidia.com"]
  resources: ["gpus", "migdevices", "migstrategies"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Security scanner permissions
- apiGroups: ["security.istio.io"]
  resources: ["authorizationpolicies", "peerauthentications", "requestauthentications"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["networking.istio.io"]
  resources: ["gateways", "virtualservices", "destinationrules", "serviceentries", "workloadentries", "envoyfilters"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["extensions.istio.io"]
  resources: ["wasmplugins", "httpapis"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["telemetry.istio.io"]
  resources: ["telemetries"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["cilium.io"]
  resources: ["ciliumendpoints", "ciliumnetworkpolicies", "ciliumclusterwidenetworkpolicies"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["calico.cni.projectcalico.org"]
  resources: ["networkpolicies", "globalnetworkpolicies", "bgpconfigurations", "bgppeers"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Logging and monitoring permissions
- apiGroups: ["logging.coreos.com"]
  resources: ["clusters", "fluentbits", "outputs"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["fluentbit.fluent.io"]
  resources: ["fluentbits", "clusterfluentbits", "clusteroutputs", "clusterfilters"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["jaegertracing.io"]
  resources: ["jaegers"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["opentelemetry.io"]
  resources: ["opentelemetrycollectors", "instrumentations"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Backup and disaster recovery permissions
- apiGroups: ["velero.io"]
  resources: ["backups", "restores", "schedules", "downloadrequests"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["ark.heptio.com"]
  resources: ["backups", "restores", "schedules"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["stash.appscode.com"]
  resources: ["backups", "restores", "repositories", "resticsessions"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Configuration management permissions
- apiGroups: ["kustomize.config.k8s.io"]
  resources: ["kustomizations"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["kpt.dev"]
  resources: ["packages", "resources"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["argoproj.io"]
  resources: ["applications", "appprojects"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["helm.toolkit.fluxcd.io"]
  resources: ["helmreleases", "helmcharts"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["kustomize.toolkit.fluxcd.io"]
  resources: ["kustomizations"]
  verbs: ["get", "list", "watch"]

# Testing and validation permissions
- apiGroups: ["testing.kyma-project.io"]
  resources: ["tests", "testsuites"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["litmuschaos.io"]
  resources: ["chaosengines", "chaosexperiments", "chaosresults"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Additional permissions for advanced features
- apiGroups: ["apiextensions.k8s.io"]
  resources: ["customresourcedefinitions"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["admissionregistration.k8s.io"]
  resources: ["mutatingwebhookconfigurations", "validatingwebhookconfigurations"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apiregistration.k8s.io"]
  resources: ["apiservices"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["rbac.authorization.k8s.io"]
  resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["authentication.k8s.io"]
  resources: ["tokenreviews"]
  verbs: ["create"]
- apiGroups: ["authorization.k8s.io"]
  resources: ["subjectaccessreviews"]
  verbs: ["create"]

# Read-only permissions for system resources
- apiGroups: [""]
  resources: ["namespaces", "resourcequotas", "limitranges"]
  verbs: ["get", "list"]
- apiGroups: ["apps"]
  resources: ["controllerrevisions"]
  verbs: ["get", "list"]
- apiGroups: ["extensions"]
  resources: ["ingresses"]
  verbs: ["get", "list", "watch"]